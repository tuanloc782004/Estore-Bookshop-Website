<!doctype html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
    xmlns:sec="https://www.thymeleaf.org/extras/spring-security6">
<head th:replace="~{admin/layout/head::head}"></head>
<body>

    <div class="wrapper">

        <div th:replace="~{admin/layout/sidebar::sidebar}"></div>

        <div class="main-panel">
            <nav th:replace="~{admin/layout/navbar::navbar}"></nav>

            <div class="content">
                <div class="container-fluid">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="card">
                                <div class="header">
                                    <div class="row align-items-center mb-3">
                                        <div class="col-md-4">
                                            <h4 class="title mb-0">List of Cart Items</h4>
                                        </div>
                                    </div>
                                    <div class="content table-responsive table-full-width">
                                        <table class="table table-hover table-striped">
                                            <thead>
                                                <tr>
                                                    <th>Book Image</th>
                                                    <th>Title</th>
                                                    <th>Price</th>
                                                    <th>Quantity</th>
                                                    <th>Total Price</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr th:each="cartItem : ${cartItems}">
                                                    <td><img
                                                        th:src="${cartItem.book.bookImages?.size() > 0 
                                                            ? cartItem.book.bookImages.iterator().next().imageUrl 
                                                            : '/upload-dir/default-image/book-image.jfif'}"
                                                        alt="Book Image" width="100" height="100"></td>
                                                    <td th:text="${cartItem.book.title}"></td>
                                                    <td>
                                                        <span th:if="${cartItem.book.discount > 0}"
                                                            th:text="${cartItem.book.price + ' $'}"
                                                            style="text-decoration: line-through; color: red;"></span>
                                                        <span class="price"
                                                            th:text="${cartItem.book.discount > 0 
                                                                ? cartItem.book.price * (100 - cartItem.book.discount) / 100.00
                                                                : cartItem.book.price}">0.00</span>
                                                    </td>
                                                    <td th:text="${cartItem.quantity}"></td>
                                                    <td>
                                                        <span class="total-price">0.00</span>
                                                    </td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="3">Total Quantity</td>
                                                    <td th:text="${totalQuantity}"></td>
                                                    <td></td>
                                                </tr>
                                                <tr>
                                                    <td colspan="4">Total Price</td>
                                                    <td th:text="${totalPrice} + ' VND'"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div th:replace="~{admin/layout/script::script}"></div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Lấy tất cả các phần tử có class price và total-price
            const priceElements = document.querySelectorAll('.price');
            const totalPriceElements = document.querySelectorAll('.total-price');

            // Cập nhật giá trị price và total price
            priceElements.forEach(function(priceElement) {
                const price = parseFloat(priceElement.textContent.trim());
                const discount = parseFloat(priceElement.getAttribute('data-discount'));

                let finalPrice = price;

                if (discount > 0) {
                    finalPrice = (price * (100 - discount) / 100);
                }

                // Format và cập nhật lại giá trị
                priceElement.textContent = finalPrice.toFixed(2) + ' $';
            });

            totalPriceElements.forEach(function(totalPriceElement) {
                // Lấy quantity và chuyển đổi nó thành kiểu số nguyên
                const quantity = parseInt(totalPriceElement.getAttribute('data-quantity'), 10);
                const price = parseFloat(totalPriceElement.textContent.trim());
                const discount = parseFloat(totalPriceElement.getAttribute('data-discount'));

                let finalPrice = price;

                if (discount > 0) {
                    finalPrice = (price * (100 - discount) / 100);
                }

                // Tính toán tổng giá và làm tròn đến 2 chữ số thập phân
                const total = quantity * finalPrice;
                totalPriceElement.textContent = total.toFixed(2) + ' $';
            });
        });
    </script>
</body>
</html>
